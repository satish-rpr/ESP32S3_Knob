substitutions:
  name: "blue-wheel"
  friendly_name: "Blue Wheel"
  device_description: "Waveshare ESP32S3-1.8-inch "
  project_name: "myprojects.Project-Blue-Wheel"
  project_version: "1.0.0"

esphome:
  name: "${name}"
  friendly_name: "${friendly_name}"
  project:
    name: "${project_name}"
    version: "${project_version}"
  platformio_options:
    board_build.flash_mode: dio
    board_build.f_flash: 80000000L
    board_build.f_cpu: 240000000L
  
  # Wait for Home Assistant before boot complete
  on_boot:
    priority: 600  # High priority to run early
    then:
      - wait_until:
          condition:
            api.connected:
              state_subscription_only: true
      - logger.log: "Home Assistant connected successfully!"
      - homeassistant.event:
          event: esphome.device_booted

esp32:
  board: esp32-s3-devkitc-1
  flash_size: 16MB
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: "y"
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B: "y"
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: y
      CONFIG_SPIRAM_RODATA: y

psram:
  mode: octal

logger:

api:
  encryption:
    key: "JVMKWt6yFfphJLHR22IYd5LOPI32I1oHHCaVJ/FkXHI="
  id: my_api
  on_client_connected: 
    then:
      - lambda: |-
                {
                  lv_led_set_color(id(ha_led), lv_color_hex(0x00ff00));
                  lv_obj_add_flag(id(busy_spinner), LV_OBJ_FLAG_HIDDEN);
                  id(ha_connection_status) = true;
                }
  on_client_disconnected: 
    then:
      - lambda: |-
                {
                  lv_led_set_color(id(ha_led), lv_color_hex(0x00ff00));
                  id(ha_connection_status) = false;
                }         

ota:
  - platform: esphome

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  manual_ip:
    static_ip: 192.168.1.104
    gateway: 192.168.1.1
    subnet: 255.255.255.0
    dns1: 8.8.8.8
  
  fast_connect: true
  power_save_mode: none

  ap:
    ssid: "${friendly_name} Fallback Hotspot"
    password: "fallbackPassw0rd"

time:
  - platform: sntp  # or homeassistant
    id: time_comp
    update_interval: 6h
    timezone: Asia/Kolkata
    servers:
      - 0.pool.ntp.org
      - 1.pool.ntp.org
    on_time_sync:
      - script.execute: update_clock
    on_time:
      - minutes: '*'
        seconds: 0
        then:
          - script.execute: update_clock


spi:
  id: display_qspi
  type: quad
  clk_pin: 13
  data_pins: [15, 16, 17, 18]

i2c:
  sda: 11
  scl: 12
  id: touchscreen_bus

globals:
  - id: current_page
    type: int
    restore_value: no
    initial_value: '1'
  - id: ha_connection_status
    type: bool
    restore_value: no
    initial_value: 'false'

touchscreen:
  platform: cst816
  id: my_touchscreen
  interrupt_pin: GPIO9
  reset_pin: GPIO10
  on_release:
    - if:
        condition: lvgl.is_paused
        then:
          - logger.log: "LVGL resuming from touch"
          - lvgl.resume:
          - lvgl.widget.redraw:
          - light.turn_on: display_backlight

light:
  - platform: monochromatic
    id: display_backlight
    name: "Backlight"
    output: backlight_pwm
    default_transition_length:
      milliseconds: 30
    initial_state:
      brightness: 50%
    restore_mode: ALWAYS_ON

  - platform: lvgl
    name: "Living One"
    id: living_1_light
    widget: living_1_led_indicator
    default_transition_length: 0ms
  
  - platform: lvgl
    name: "Living Two"
    id: living_2_light
    widget: living_2_led_indicator
    default_transition_length: 0ms

  - platform: lvgl
    name: "Living Three"
    id: living_3_light
    widget: living_3_led_indicator
    default_transition_length: 0ms
  
  - platform: lvgl
    name: "Dining One"
    id: dining_1_light
    widget: dining_1_led_indicator
    default_transition_length: 0ms

  - platform: lvgl
    name: "Dining Two"
    id: dining_2_light
    widget: dining_2_led_indicator
    default_transition_length: 0ms

switch:
  - platform: lvgl
    id: living_1_switch
    name: "Living 1 switch"
    widget: living_led_1_switch_widget

  - platform: lvgl
    id: living_2_switch
    name: "Living 2 switch"
    widget: living_led_2_switch_widget

  - platform: lvgl
    id: living_3_switch
    name: "Living 3 switch"
    widget: living_led_3_switch_widget

  - platform: lvgl
    id: dining_1_switch
    name: "Dining 1 switch"
    widget: dining_led_1_switch_widget
  
  - platform: lvgl
    id: dining_2_switch
    name: "Dining 2 switch"
    widget: dining_led_2_switch_widget
  
  - platform: template
    name: Antiburn
    id: switch_antiburn
    icon: mdi:television-shimmer
    optimistic: true
    entity_category: "config"
    turn_on_action:
      - logger.log: "Starting Antiburn"
      - if:
          condition: lvgl.is_paused
          then:
            - lvgl.resume:
            - lvgl.widget.redraw:
      - lvgl.pause:
          show_snow: true
    turn_off_action:
      - logger.log: "Stopping Antiburn"
      - if:
          condition: lvgl.is_paused
          then:
            - lvgl.resume:
            - lvgl.widget.redraw:

font:
  - file: "gfonts://Roboto"
    id: roboto_20
    size: 20
    glyphsets:
      - GF_Latin_Core
  - file: "gfonts://Roboto"
    id: roboto_32
    size: 32
    glyphsets:
      - GF_Latin_Core
  - file: "gfonts://Roboto"
    id: roboto_88
    size: 88
    glyphsets:
      - GF_Latin_Core   
         
output:
  - platform: ledc
    pin:
      number: GPIO47
    id: backlight_pwm

display:
  - platform: qspi_dbi
    id: my_display
    model: CUSTOM
    data_rate: 80MHz
    color_order: rgb
    dimensions:
      height: 360
      width: 360
    cs_pin: 14
    reset_pin: 21
    invert_colors: true
    rotation: 180
    auto_clear_enabled: false
    init_sequence:
      - [0xF0, 0x28]
      - [0xF2, 0x28]
      - [0x73, 0xF0]
      - [0x7C, 0xD1]
      - [0x83, 0xE0]
      - [0x84, 0x61]
      - [0xF2, 0x82]
      - [0xF0, 0x00]
      - [0xF0, 0x01]
      - [0xF1, 0x01]
      - [0xB0, 0x56]
      - [0xB1, 0x4D]
      - [0xB2, 0x24]
      - [0xB4, 0x87]
      - [0xB5, 0x44]
      - [0xB6, 0x8B]
      - [0xB7, 0x40]
      - [0xB8, 0x86]
      - [0xBA, 0x00]
      - [0xBB, 0x08]
      - [0xBC, 0x08]
      - [0xBD, 0x00]
      - [0xC0, 0x80]
      - [0xC1, 0x10]
      - [0xC2, 0x37]
      - [0xC3, 0x80]
      - [0xC4, 0x10]
      - [0xC5, 0x37]
      - [0xC6, 0xA9]
      - [0xC7, 0x41]
      - [0xC8, 0x01]
      - [0xC9, 0xA9]
      - [0xCA, 0x41]
      - [0xCB, 0x01]
      - [0xD0, 0x91]
      - [0xD1, 0x68]
      - [0xD2, 0x68]
      - [0xF5, 0x00, 0xA5]
      - [0xDD, 0x4F]
      - [0xDE, 0x4F]
      - [0xF1, 0x10]
      - [0xF0, 0x00]
      - [0xF0, 0x02]
      - [
          0xE0,
          0xF0,
          0x0A,
          0x10,
          0x09,
          0x09,
          0x36,
          0x35,
          0x33,
          0x4A,
          0x29,
          0x15,
          0x15,
          0x2E,
          0x34,
        ]
      - [
          0xE1,
          0xF0,
          0x0A,
          0x0F,
          0x08,
          0x08,
          0x05,
          0x34,
          0x33,
          0x4A,
          0x39,
          0x15,
          0x15,
          0x2D,
          0x33,
        ]
      - [0xF0, 0x10]
      - [0xF3, 0x10]
      - [0xE0, 0x07]
      - [0xE1, 0x00]
      - [0xE2, 0x00]
      - [0xE3, 0x00]
      - [0xE4, 0xE0]
      - [0xE5, 0x06]
      - [0xE6, 0x21]
      - [0xE7, 0x01]
      - [0xE8, 0x05]
      - [0xE9, 0x02]
      - [0xEA, 0xDA]
      - [0xEB, 0x00]
      - [0xEC, 0x00]
      - [0xED, 0x0F]
      - [0xEE, 0x00]
      - [0xEF, 0x00]
      - [0xF8, 0x00]
      - [0xF9, 0x00]
      - [0xFA, 0x00]
      - [0xFB, 0x00]
      - [0xFC, 0x00]
      - [0xFD, 0x00]
      - [0xFE, 0x00]
      - [0xFF, 0x00]
      - [0x60, 0x40]
      - [0x61, 0x04]
      - [0x62, 0x00]
      - [0x63, 0x42]
      - [0x64, 0xD9]
      - [0x65, 0x00]
      - [0x66, 0x00]
      - [0x67, 0x00]
      - [0x68, 0x00]
      - [0x69, 0x00]
      - [0x6A, 0x00]
      - [0x6B, 0x00]
      - [0x70, 0x40]
      - [0x71, 0x03]
      - [0x72, 0x00]
      - [0x73, 0x42]
      - [0x74, 0xD8]
      - [0x75, 0x00]
      - [0x76, 0x00]
      - [0x77, 0x00]
      - [0x78, 0x00]
      - [0x79, 0x00]
      - [0x7A, 0x00]
      - [0x7B, 0x00]
      - [0x80, 0x48]
      - [0x81, 0x00]
      - [0x82, 0x06]
      - [0x83, 0x02]
      - [0x84, 0xD6]
      - [0x85, 0x04]
      - [0x86, 0x00]
      - [0x87, 0x00]
      - [0x88, 0x48]
      - [0x89, 0x00]
      - [0x8A, 0x08]
      - [0x8B, 0x02]
      - [0x8C, 0xD8]
      - [0x8D, 0x04]
      - [0x8E, 0x00]
      - [0x8F, 0x00]
      - [0x90, 0x48]
      - [0x91, 0x00]
      - [0x92, 0x0A]
      - [0x93, 0x02]
      - [0x94, 0xDA]
      - [0x95, 0x04]
      - [0x96, 0x00]
      - [0x97, 0x00]
      - [0x98, 0x48]
      - [0x99, 0x00]
      - [0x9A, 0x0C]
      - [0x9B, 0x02]
      - [0x9C, 0xDC]
      - [0x9D, 0x04]
      - [0x9E, 0x00]
      - [0x9F, 0x00]
      - [0xA0, 0x48]
      - [0xA1, 0x00]
      - [0xA2, 0x05]
      - [0xA3, 0x02]
      - [0xA4, 0xD5]
      - [0xA5, 0x04]
      - [0xA6, 0x00]
      - [0xA7, 0x00]
      - [0xA8, 0x48]
      - [0xA9, 0x00]
      - [0xAA, 0x07]
      - [0xAB, 0x02]
      - [0xAC, 0xD7]
      - [0xAD, 0x04]
      - [0xAE, 0x00]
      - [0xAF, 0x00]
      - [0xB0, 0x48]
      - [0xB1, 0x00]
      - [0xB2, 0x09]
      - [0xB3, 0x02]
      - [0xB4, 0xD9]
      - [0xB5, 0x04]
      - [0xB6, 0x00]
      - [0xB7, 0x00]
      - [0xB8, 0x48]
      - [0xB9, 0x00]
      - [0xBA, 0x0B]
      - [0xBB, 0x02]
      - [0xBC, 0xDB]
      - [0xBD, 0x04]
      - [0xBE, 0x00]
      - [0xBF, 0x00]
      - [0xC0, 0x10]
      - [0xC1, 0x47]
      - [0xC2, 0x56]
      - [0xC3, 0x65]
      - [0xC4, 0x74]
      - [0xC5, 0x88]
      - [0xC6, 0x99]
      - [0xC7, 0x01]
      - [0xC8, 0xBB]
      - [0xC9, 0xAA]
      - [0xD0, 0x10]
      - [0xD1, 0x47]
      - [0xD2, 0x56]
      - [0xD3, 0x65]
      - [0xD4, 0x74]
      - [0xD5, 0x88]
      - [0xD6, 0x99]
      - [0xD7, 0x01]
      - [0xD8, 0xBB]
      - [0xD9, 0xAA]
      - [0xF3, 0x01]
      - [0xF0, 0x00]
      - [0xF0, 0x01]
      - [0xF1, 0x01]
      - [0xA0, 0x0B]
      - [0xA3, 0x2A]
      - [0xA5, 0xC3]
      - delay 1ms
      - [0xA3, 0x2B]
      - [0xA5, 0xC3]
      - delay 1ms
      - [0xA3, 0x2C]
      - [0xA5, 0xC3]
      - delay 1ms
      - [0xA3, 0x2D]
      - [0xA5, 0xC3]
      - delay 1ms
      - [0xA3, 0x2E]
      - [0xA5, 0xC3]
      - delay 1ms
      - [0xA3, 0x2F]
      - [0xA5, 0xC3]
      - delay 1ms
      - [0xA3, 0x30]
      - [0xA5, 0xC3]
      - delay 1ms
      - [0xA3, 0x31]
      - [0xA5, 0xC3]
      - delay 1ms
      - [0xA3, 0x32]
      - [0xA5, 0xC3]
      - delay 1ms
      - [0xA3, 0x33]
      - [0xA5, 0xC3]
      - delay 1ms
      - [0xA0, 0x09]
      - [0xF1, 0x10]
      - [0xF0, 0x00]
      - [0x2A, 0x00, 0x00, 0x01, 0x67]
      - [0x2B, 0x01, 0x68, 0x01, 0x68]
      - [0x4D, 0x00]
      - [0x4E, 0x00]
      - [0x4F, 0x00]
      - [0x4C, 0x01]
      - delay 10ms
      - [0x4C, 0x00]
      - [0x2A, 0x00, 0x00, 0x01, 0x67]
      - [0x2B, 0x00, 0x00, 0x01, 0x67]
      - [0x3A, 0x55]
      - [0x21, 0x00]
      - [0x11, 0x00]
      - delay 120ms
      - [0x29, 0x00]

binary_sensor:
  - platform: gpio
    id: encoder_pin_a
    pin:
      number: GPIO7
      mode: INPUT_PULLUP
    on_press:
       then:
            - light.dim_relative:
                id: living_1_light
                relative_brightness: -10%
                brightness_limits:
                  min_brightness: 10%
                  max_brightness: 100%
             
            - if:
                condition:
                  or:
                  - lvgl.is_paused
                  - light.is_off: display_backlight
                then:
                  - logger.log: "LVGL resuming from encoder"
                  - lvgl.resume:
                  - lvgl.widget.redraw:
                  - light.turn_on: display_backlight

  - platform: gpio
    id: encoder_pin_b
    pin:
      number: GPIO8
      mode: INPUT_PULLUP
    on_press:
      then:
            - light.dim_relative:
                id: living_1_light
                relative_brightness: 10%
                brightness_limits:
                  min_brightness: 10%
                  max_brightness: 100%

            - if:
                condition: 
                  or:
                  - lvgl.is_paused
                  - light.is_off: display_backlight
                then:
                  - logger.log: "LVGL resuming from encoder"
                  - lvgl.resume:
                  - lvgl.widget.redraw:
                  - light.turn_on: display_backlight
  
  - platform: status
    name: "Device status"
  
lvgl:
  on_idle:
    - timeout: 0ms
      then:
        - if:
            condition:
              lvgl.page.is_showing: clock_6_page
            then:
              - lambda: |-
                        {
                          lv_obj_add_flag(id(ha_led), LV_OBJ_FLAG_HIDDEN);
                        }
    - timeout: 30s
      then:
        - light.turn_off:
            id: display_backlight
            transition_length: 3s
        - lvgl.pause:
            show_snow: true

  on_resume:
   - light.turn_on:
      id: display_backlight
      transition_length: 1s

  resume_on_input: true
  
  displays: 
    - my_display

  top_layer:
    widgets:
      - label:
          id: battery_percentage_label
          align: bottom_mid
          y: -10
          text: " "
          text_font: roboto_20
          text_color: 0xFFFFFF
          clickable: false
      
      - led:
          id: ha_led
          align: bottom_mid
          y: -30
          clickable: false
      
      - spinner:
          id: busy_spinner
          align: CENTER
          y: 95
          height: 50
          width: 50
          spin_time: 1s
          arc_length: 60deg
          arc_width: 8
          indicator:
            arc_color: 0x18bcf2
            arc_width: 8
 
  pages:
    # First Page
    - id: living_1_page
      widgets:
        - obj:
            id: background_1
            x: 0
            y: 0
            width: 360
            height: 360
            bg_color: 0x000000
            border_width: 0
            pad_all: 0
        
        - switch:
            id: living_led_1_switch_widget
            width: 150
            height: 80
            align: center
            on_value:
              then:
              - if:
                  condition:
                    - lambda: 'return x == 1;'
                  then:
                    - light.turn_on: living_1_light
                    - lambda: 'ESP_LOGI("INFO","Living one ON");'
                  else:
                    - light.turn_off: living_1_light
                    - lambda: 'ESP_LOGI("INFO","Living one OFF");'

        - led:
            id: living_1_led_indicator
            width: 50
            height: 50
            x: -130
            y: -156
            align: bottom_mid
            color: 0x00FF00
        
        - label:
            id: living_1_brightness_label
            align_to:
              id: living_1_led_indicator
              align: bottom_mid
            x: 50
            y: -20
            text: "--%"
            text_font: roboto_32
            text_color: 0xFFFFFF

        - label:
            id: living_1_page_label
            align: top_mid
            y: 40
            text: "Living 1"
            text_font: roboto_32
            text_color: 0xFFFFFF

      on_swipe_left:
        - lambda: 'id(current_page) = 6;'
        - lvgl.page.show:
            id: clock_6_page
            animation: OUT_LEFT

      on_swipe_right:
        - lambda: 'id(current_page) = 2;'
        - lvgl.page.show:
            id: living_2_page 
            animation: OUT_RIGHT
    
    # Page 2
    - id: living_2_page
      widgets:
        - obj:
            id: background_2
            x: 0
            y: 0
            width: 360
            height: 360
            bg_color: 0x000000
            border_width: 0
            pad_all: 0
        
        - switch:
            id: living_led_2_switch_widget
            width: 150
            height: 80
            align: center
            on_value:
              then:
              - if:
                  condition:
                    - lambda: 'return x == 1;'
                  then:
                    - light.turn_on: living_2_light
                    - lambda: 'ESP_LOGI("INFO","Living two ON");'
                  else:
                    - light.turn_off: living_2_light
                    - lambda: 'ESP_LOGI("INFO","Living two OFF");'

        - led:
            id: living_2_led_indicator
            width: 50
            height: 50
            x: -130
            y: -156
            align: bottom_mid
            color: 0x00FF00
        
        - label:
            id: living_2_brightness_label
            align_to:
              id: living_2_led_indicator
              align: bottom_mid
            x: 50
            y: -20
            text: "--%"
            text_font: roboto_32
            text_color: 0xFFFFFF

        - label:
            id: living_2_page_label
            align: top_mid
            y: 40
            text: "Living 2"
            text_font: roboto_32
            text_color: 0xFFFFFF
    
      on_swipe_left:
        - lambda: 'id(current_page) = 1;'
        - lvgl.page.show:
            id: living_1_page
            animation: OUT_LEFT
      on_swipe_right:
        - lambda: 'id(current_page) = 3;'
        - lvgl.page.show:  
            id: living_3_page
            animation: OUT_RIGHT

    # Page 3
    - id: living_3_page
      widgets:
        - obj:
            id: background_3
            x: 0
            y: 0
            width: 360
            height: 360
            bg_color: 0x000000
            border_width: 0
            pad_all: 0
        
        - switch:
            id: living_led_3_switch_widget
            width: 150
            height: 80
            align: center
            on_value:
              then:
              - if:
                  condition:
                    - lambda: 'return x == 1;'
                  then:
                    - light.turn_on: living_3_light
                    - lambda: 'ESP_LOGI("INFO","Living three ON");'
                  else:
                    - light.turn_off: living_3_light
                    - lambda: 'ESP_LOGI("INFO","Living three OFF");'

        - led:
            id: living_3_led_indicator
            width: 50
            height: 50
            x: -130
            y: -156
            align: bottom_mid
            color: 0x00FF00
        
        - label:
            id: living_3_brightness_label
            align_to:
              id: living_3_led_indicator
              align: bottom_mid
            x: 50
            y: -20
            text: "--%"
            text_font: roboto_32
            text_color: 0xFFFFFF

        - label:
            id: living_3_page_label
            align: top_mid
            y: 40
            text: "Living 3"
            text_font: roboto_32
            text_color: 0xFFFFFF
    
      on_swipe_left:
        - lambda: 'id(current_page) = 2;'
        - lvgl.page.show:
            id: living_2_page
            animation: OUT_LEFT
      on_swipe_right:
        - lambda: 'id(current_page) = 4;'
        - lvgl.page.show:  
            id: dining_1_page
            animation: OUT_RIGHT

    # Page 4
    - id: dining_1_page
      widgets:
        - obj:
            id: background_4
            x: 0
            y: 0
            width: 360
            height: 360
            bg_color: 0x000000
            border_width: 0
            pad_all: 0
        
        - switch:
            id: dining_led_1_switch_widget
            width: 150
            height: 80
            align: center
            on_value:
              then:
              - if:
                  condition:
                    - lambda: 'return x == 1;'
                  then:
                    - light.turn_on: dining_1_light
                    - lambda: 'ESP_LOGI("INFO","Dining one ON");'
                  else:
                    - light.turn_off: dining_1_light
                    - lambda: 'ESP_LOGI("INFO","Dining one OFF");'

        - led:
            id: dining_1_led_indicator
            width: 50
            height: 50
            x: -130
            y: -156
            align: bottom_mid
            color: 0x00FF00
        
        - label:
            id: dining_1_brightness_label
            align_to:
              id: dining_1_led_indicator
              align: bottom_mid
            x: 50
            y: -20
            text: "--%"
            text_font: roboto_32
            text_color: 0xFFFFFF

        - label:
            id: dining_1_page_label
            align: top_mid
            y: 40
            text: "Dining 1"
            text_font: roboto_32
            text_color: 0xFFFFFF
    
      on_swipe_left:
        - lambda: 'id(current_page) = 3;'
        - lvgl.page.show:
            id: living_3_page
            animation: OUT_LEFT
      on_swipe_right:
        - lambda: 'id(current_page) = 5;'
        - lvgl.page.show:  
            id: dining_2_page
            animation: OUT_RIGHT
    
    # Page 5
    - id: dining_2_page
      widgets:
        - obj:
            id: background_5
            x: 0
            y: 0
            width: 360
            height: 360
            bg_color: 0x000000
            border_width: 0
            pad_all: 0
        
        - switch:
            id: dining_led_2_switch_widget
            width: 150
            height: 80
            align: center
            on_value:
              then:
              - if:
                  condition:
                    - lambda: 'return x == 1;'
                  then:
                    - light.turn_on: dining_2_light
                    - lambda: 'ESP_LOGI("INFO","Dining two ON");'
                  else:
                    - light.turn_off: dining_2_light
                    - lambda: 'ESP_LOGI("INFO","Dining two OFF");'

        - led:
            id: dining_2_led_indicator
            width: 50
            height: 50
            x: -130
            y: -156
            align: bottom_mid
            color: 0x00FF00
        
        - label:
            id: dining_2_brightness_label
            align_to:
              id: dining_2_led_indicator
              align: bottom_mid
            x: 50
            y: -20
            text: "--%"
            text_font: roboto_32
            text_color: 0xFFFFFF

        - label:
            id: dining_2_page_label
            align: top_mid
            y: 40
            text: "Dining 2"
            text_font: roboto_32
            text_color: 0xFFFFFF
    
      on_swipe_left:
        - lambda: 'id(current_page) = 4;'
        - lvgl.page.show:
            id: dining_1_page
            animation: OUT_LEFT
      on_swipe_right:
        - lambda: 'id(current_page) = 6;'
        - lvgl.page.show:  
            id: clock_6_page
            animation: OUT_RIGHT
    
    # Page 6 - clock
    - id: clock_6_page
      width: 100%
      bg_color: Black
      widgets:
          # Outer Clock Container
          - obj:
              height: 360
              width: 360
              align: center
              pad_all: 4
              bg_color: Black
              border_width: 0  
              gesture_bubble: true
              event_bubble: true
              clickable: false
              widgets:
              - meter:
                  clickable: false
                  gesture_bubble: true
                  height: 100%
                  width: 100%
                  align: center
                  bg_color: Black
                  scales:
                    # Minor ticks
                    - ticks:
                        width: 2
                        count: 61
                        length: 10
                        color: white
                      range_from: 0
                      range_to: 60
                      angle_range: 360
                      rotation: 270

                      # Minuite hand
                      indicators:
                        - line:
                            id: minute_hand
                            width: 3
                            color: silver
                            r_mod: -1     

                    # Major ticks
                    - angle_range: 330
                      rotation: 300
                      range_from: 1
                      range_to: 12
                      ticks:
                        width: 3
                        count: 12
                        length: 20
                        color: White  

                    # Hour hand
                    - angle_range: 360
                      rotation: 270
                      range_from: 0
                      range_to: 720
                      indicators:
                        - line:
                            id: hour_hand
                            width: 4
                            color: silver
                            r_mod: -40

                    # Second hand
                    - angle_range: 360
                      rotation: 270
                      range_from: 0
                      range_to: 60
                      indicators:
                        - line:
                            id: second_hand
                            width: 2
                            color: Red
                            r_mod: -10
      on_swipe_left:
        - lambda: |- 
                  {
                    id(current_page) = 5;
                    ESP_LOGD("DEBUG", "Left swipee from clock  page : %d", id(current_page));
                  }
        - lvgl.page.show:
            id: dining_2_page
            animation: OUT_LEFT
      on_swipe_right:
        - lambda: |- 
                  {
                    id(current_page) = 1;
                    ESP_LOGD("DEBUG", "Right swipee from clock  page : %d", id(current_page));
                  }
        - lvgl.page.show:  
            id: living_1_page
            animation: OUT_RIGHT
  
sensor:
  - platform: adc
    pin: 1
    name: "Battery Voltage"
    id: battery_voltage
    attenuation: 12db
    accuracy_decimals: 2
    update_interval: 10s
    unit_of_measurement: "V"
    icon: mdi:battery-medium
    filters:
      - multiply: 2.0
      - median:
          window_size: 7
          send_every: 7
          send_first_at: 7
      - throttle: 1min
    on_value:
      then:
        - component.update: battery_percentage

  - platform: template
    id: battery_percentage
    name: "Battery Percentage"
    lambda: return id(battery_voltage).state;
    accuracy_decimals: 0
    unit_of_measurement: "%"
    icon: mdi:battery-medium
    filters:
      - calibrate_linear:
         method: exact
         datapoints:
          - 2.80 -> 0.0
          - 3.10 -> 10.0
          - 3.30 -> 20.0
          - 3.45 -> 30.0
          - 3.60 -> 40.0
          - 3.70 -> 50.0
          - 3.75 -> 60.0
          - 3.80 -> 70.0
          - 3.90 -> 80.0
          - 4.00 -> 90.0
          - 4.20 -> 100.0
      - lambda: |-
          if (x > 100) return 100;
          if (x < 0) return 0;
          return x;
    on_value:
      then:
        - lvgl.label.update:
            id: battery_percentage_label
            text: !lambda |-
              static char buf[8];
              if ((int)x < 0 || (int)x > 100) {
                snprintf(buf, sizeof(buf), "%s", "---%");
                return buf;
              } else {
                snprintf(buf, sizeof(buf), "%d%%", (int)x);
                return buf;
              }
interval:
  - interval: 1s
    then:
      - if:
          condition:
            - lvgl.page.is_showing: clock_6_page
          then:
            - lvgl.indicator.update:
                id: second_hand
                value: !lambda 'return id(time_comp).now().second;'

script:
  - id: update_clock
    then:
      - lvgl.indicator.update:
          id: minute_hand
          value: !lambda 'return id(time_comp).now().minute;'
      - lvgl.indicator.update:
          id: hour_hand
          value: !lambda |-
            auto now = id(time_comp).now();
            return std::fmod(now.hour, 12) * 60 + now.minute;
      - lvgl.indicator.update:
          id: second_hand
          value: !lambda 'return id(time_comp).now().second;'
  
  
    
              